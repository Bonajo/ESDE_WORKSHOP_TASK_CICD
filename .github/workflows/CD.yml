name: CD (Docker & Pages)

on:
  # Run CD automatically after CI finishes on main
  workflow_run:
    workflows: ["CI (Build & Test)"]
    types: [completed]
    branches: [main]

  # Allow manual runs from the Actions tab (useful in a workshop)
  workflow_dispatch:

concurrency:
  group: cd-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# Keep permissions minimal by default.
# Students should uncomment what they need when they implement Docker & Pages.
permissions:
  contents: read
  # packages: write   # TODO (Docker): needed if you push images to GHCR
  # pages: write      # TODO (Pages): needed if you deploy GitHub Pages
  # id-token: write   # TODO (Pages): needed by deploy-pages for OIDC

jobs:
  docker:
    name: Docker (Build, Push & E2E) – Skeleton
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CI commit (or current on manual run)
        uses: actions/checkout@v4
        with:
          # For workflow_run, this is the commit that CI built.
          # For manual runs, fall back to the current commit.
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Docker Buildx (for advanced builds/multi-arch)
        uses: docker/setup-buildx-action@v3

      - name: Compute lowercase GHCR repo name
        id: repo
        run: |
          # GITHUB_REPOSITORY can contain uppercase letters,
          # but Docker image names in GHCR must be lowercase.
          # Example: "FontysVenlo/Repo" -> "fontysvenlo/repo"
          REPO_LC="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          echo "repo_lc=$REPO_LC" >> "$GITHUB_OUTPUT"

      # ------------------------- STUDENT TODOs (Docker & E2E) -------------------------

      # TODO 1 – Log in to a container registry (e.g., GHCR)
      #
      # Goal:
      #   Allow this workflow to push images to a registry (and pull them again for tests).
      #
      # Expectations:
      #   - Use a login mechanism suitable for CI (not manual 'docker login').
      #   - For GHCR, authenticate as the GitHub Actions runner using the built-in GITHUB_TOKEN.
      #   - Ensure this step runs before any push or E2E test that needs to pull the image.
      #
      # Hint:
      #   - For GHCR, the registry hostname is "ghcr.io".
      #   - The image name will later look like: ghcr.io/<lowercase owner>/<lowercase repo>:<tag>
      #
      - name: TODO – Login to container registry
        run: 
        echo "TODO: log in to the chosen registry (e.g., GHCR using GITHUB_TOKEN)."

      # TODO 2 – Build and push a Docker image
      #
      # Goal:
      #   Build the application image from this repository and push it to the registry.
      #
      # Expectations:
      #   - Use the repository root (.) as the build context.
      #   - Tag the image using the lowercase repo name from the previous step:
      #       ghcr.io/${{ steps.repo.outputs.repo_lc }}:<tag>
      #   - Push at least:
      #       - a stable tag (e.g., "latest"),
      #       - and a commit-specific tag (e.g., based on the current SHA).
      #   - (Optional) Enable build cache to speed up subsequent builds.
      #
      - name: TODO – Build & push Docker image
        run: |
          echo "TODO: build the image from '.' and push tags like:"
          echo "  ghcr.io/${{ steps.repo.outputs.repo_lc }}:latest"
          echo "  ghcr.io/${{ steps.repo.outputs.repo_lc }}:<commit-hash>"


      # TODO 3 – End-to-end (E2E) container smoke test
      #
      # Goal:
      #   Verify that the freshly built image actually runs and responds correctly,
      #   similar to how a real user (or client) would use it.
      #
      # Expectations:
      #   - Start a container from the image you just pushed
      #     (for example: ghcr.io/<lowercase repo>:latest).
      #   - Wait until a health endpoint responds successfully (e.g., /api/health).
      #   - Call another real endpoint (e.g., /api/info) and fail the job if it
      #     does not return a successful HTTP response.
      #   - Stop the container at the end, even if something goes wrong.
      #
      # Hints:
      #   - Use a small loop to poll the health endpoint with a timeout.
      #   - Print container logs when something fails to help with debugging.
      #
      - name: TODO – E2E smoke test against container
        run: |
          echo "TODO: run a container from ghcr.io/${{ steps.repo.outputs.repo_lc }}:latest,"
          echo "      poll /api/health until it is OK, then call /api/info and stop the container."

      # -------------------------------------------------------------------------------

  pages:
    name: GitHub Pages – Skeleton
    needs: docker
    runs-on: ubuntu-latest
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout CI commit (or current on manual run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle (with caching)
        uses: gradle/actions/setup-gradle@v4

      # ------------------------- STUDENT TODOs (Pages) -------------------------

      # TODO 4 – Re-run tests and generate coverage in CD
      #
      # Goal:
      #   Ensure the CD pipeline also has a fresh view of test status and coverage,
      #   and generate the coverage report that will be referenced by the Pages output.
      #
      # Expectations:
      #   - Run the project tests.
      #   - Generate the coverage reports (XML + HTML) used elsewhere in the pipeline.
      #
      - name: TODO – Run tests & generate coverage
        run: |
          echo "TODO: run the test task(s) that also produce coverage reports."

      # TODO 5 – Generate static content for GitHub Pages
      #
      # Goal:
      #   Produce a small static site (in docs/) that summarises build information
      #   (e.g., version, coverage, build number).
      #
      # Expectations:
      #   - Execute the existing task/class that writes into the docs/ directory.
      #   - Include some notion of build/run identifier (e.g., workflow run number).
      #   - Ensure docs/ contains at least an index page and supporting data files.
      #
      # TODO 5 – Generate static content for GitHub Pages
      - name: TODO – Generate Pages content (docs/)
        run: |
          echo "TODO: generate the docs/ folder with a simple build summary site."

      # TODO 6 – Configure and deploy GitHub Pages
      #
      # Goal:
      #   Publish the docs/ directory as a GitHub Pages site whenever CD succeeds.
      #
      # Expectations:
      #   - At the top of the workflow, enable:
      #       pages: write
      #       id-token: write
      #   - Use the official GitHub Actions to:
      #       1) configure Pages for this repository,
      #       2) upload docs/ as a Pages artifact,
      #       3) deploy that artifact to the GitHub Pages environment.
      #   - After a successful run, the Pages URL should appear in the workflow summary.
      #
      # Hints:
      #   - The upload step should point exactly at the docs/ directory.
      #   - The deploy step typically depends on the uploaded artifact and exposes a URL.
      #
      - name: TODO – Configure & deploy GitHub Pages
        run: |
          echo "TODO: configure Pages, upload the docs/ artifact,"
          echo "      and deploy it so the build summary becomes visible as a website."

      # -----------------------------------------------------------------------

      # TODO: students: Deploy GitHub Pages
      - name: TODO – Deploy Pages
        run: |
          echo "TODO: pages deploy"
